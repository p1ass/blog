---
title: Twitter API v2ã®OAuth 2.0 Authorization Code Flow with PKCEã‚’è©¦ã—ãŸ
date: 2022-03-23T00:00:00
draft: false
description: ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ç´°ã‹ãåˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€ä»Šã¾ã§ã®ã‚ˆã†ã«ä¸ç”¨æ„ã«å¤šãã®æ¨©é™ã‚’è¦æ±‚ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã—ãŸï¼
categories:
  - é–‹ç™º
tags:
  - Twitter
  - OAuth
share: true
---

import { ExLinkCard } from "../../../components/ExLinkCard";

ã“ã‚“ã«ã¡ã¯ã€{/* {<link href="https://twitter.com/p1ass" text="@p1ass" >} */}ã§ã™ã€‚

Twitter API ã® v2 ãŒæ­£å¼ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã‹ã‚‰æ•°ãƒ¶æœˆçµŒã¡ã¾ã—ãŸã€‚

<ExLinkCard url="https://forest.watch.impress.co.jp/docs/news/1366790.html" />

Twitter API v2 ã§ã¯æ§˜ã€…ãª API ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ãŒã€ä¸­ã§ã‚‚æ³¨ç›®ã™ã¹ãã¯ OAuth 2.0 å¯¾å¿œã ã¨æ€ã„ã¾ã™ã€‚

<ExLinkCard url="https://developer.twitter.com/en/docs/authentication/oauth-2-0/authorization-code" />

ä»Šã¾ã§ã¯ OAuth 1.0a ã—ã‹å¯¾å¿œã—ã¦ãŠã‚‰ãšã€ä»–ã® OAuth 2.0 å¯¾å¿œã®èªå¯ã‚µãƒ¼ãƒãƒ¼ã¨æ¯”è¼ƒã—ã¦ä½¿ã„ã¥ã‚‰ã„ã¨æ„Ÿã˜ã¦ã„ã¾ã—ãŸã€‚
ä»Šå›ã®å¯¾å¿œã«ã‚ˆã£ã¦ã€OAuth 2.0 ã® Authorization Code Flow ( [RFC6749 Section4.1](https://www.rfc-editor.org/rfc/rfc6749.html#section-4.1))ã‚’åˆ©ç”¨ã—ãŸèªå¯ã«å¯¾å¿œã—ã€ã‚ˆã‚Šä¾¿åˆ©ã«èªå¯ã‚’ã‚·ã‚¹ãƒ†ãƒ ã«çµ„ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ã¾ãŸã€ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ç´°ã‹ãåˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€**ä»Šã¾ã§ã®ã‚ˆã†ã«ä¸ç”¨æ„ã«å¤šãã®æ¨©é™ã‚’è¦æ±‚ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã—ãŸï¼**
ç¾åœ¨å¯¾å¿œã—ã¦ã„ã‚‹ã‚¹ã‚³ãƒ¼ãƒ—ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã€éå¸¸ã«ç´°ã‹ãã‚¹ã‚³ãƒ¼ãƒ—ã‚’åˆ¶å¾¡ã§ãã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

- tweet.read
- tweet.write
- tweet.moderate.write
- users.read
- follows.read
- follows.write
- offline.access
- space.read
- mute.read
- mute.write
- like.read
- like.write
- list.read
- list.write
- block.read
- block.write

ã¨ã„ã†ã‚ã‘ã§ã€ã›ã£ã‹ã OAuth 2.0 ã«å¯¾å¿œã—ãŸã“ã¨ãªã®ã§ã€å®Ÿéš›ã« Authorization Code Flow ã‚’è©¦ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

{/* <!--more--> */}

## Twitter Developer Portal ã§è¨­å®šã™ã‚‹

ã¾ãšã¯ã˜ã‚ã«ã€Twitter ã® [Developer Portal](https://developer.twitter.com/en/portal/dashboard) ã§ã‚¢ãƒ—ãƒªã®ç™»éŒ²ã‚’ã—ã¾ã™ã€‚
è©³ç´°ã¯çœãã¾ã™ãŒã€OAuth2.0 ã®è¨­å®šéƒ¨åˆ†ã¯ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

![Twitterã®OAuthè¨­å®šç”»é¢](./setting.png)
_Twitter ã® OAuth è¨­å®šç”»é¢_

ã‚ˆãã‚ã‚‹ Callback URI ã®è¨­å®šã‚„ Website URL ãªã©ã®ç™»éŒ²ãŒã‚ã‚Šã¾ã™ã€‚
ä¸­ã§ã‚‚ç‰¹ç­†ã™ã¹ãç‚¹ã¯ã€Type of Apps ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡ã‚’é¸æŠã™ã‚‹ç‚¹ã§ã™ã€‚

![Type of App](./type_of_app.png)
_Type of App ã®è¨­å®š_

ã“ã“ã§ã¯ã€

- Native App
- Single page App
- Web App
- Automated App or bot

ã‹ã‚‰ã€ã‚ãªãŸã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡ã‚’é¸æŠã—ã¾ã™ã€‚

ã“ã‚Œã¯ Client Type( [RFC6749 Section2.1](https://www.rfc-editor.org/rfc/rfc6749.html#section-2.1))ã‚’åˆ¤åˆ¥ã™ã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œã¾ã™ã€‚
Client Secret ã‚’å®‰å…¨ã«ä¿ç®¡ã§ããªã„ Public Client ã®å ´åˆã¯ã€

> This type of App uses public clients as theyâ€™re usually running in a browser or on a mobile device and are unable to use your client secrets.

ã¨è¡¨ç¤ºã•ã‚Œã€Client Secret ãŒä½¿ãˆãªããªã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€Public Client ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼ã¯ PKCE ã§æ‹…ä¿ã™ã‚‹ã“ã¨ã«ãªã‚‹ã¨æ€ã‚ã‚Œã¾ã™ãŒã€å‹•ä½œæ¤œè¨¼ã¯ã—ã¦ãªã„ã®ã§æœªç¢ºèªã§ã™ã€‚

ä»Šå›ã¯ã€Web App ã‚’é¸æŠã—ã¾ã™ã€‚
è¨­å®šå®Œäº†å¾Œã€Client ID ã¨ Client Secret ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ãƒ¡ãƒ¢ã£ã¦ãŠãã¾ã™ã€‚

## OAuth ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç™»éŒ²ãŒå®Œäº†ã—ãŸã®ã§ã€å®Ÿéš›ã«èªå¯ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚
ä»Šå›ã¯ Go ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¾ã™ã€‚
ãƒ‡ãƒ¢ç”¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ä»¥ä¸‹ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã„ã¦ã‚ã‚Šã¾ã™ã€‚

<ExLinkCard url="https://github.com/p1ass/twitter-oauth-2-demo" />

### èªå¯ URL ã®ç”Ÿæˆ

ã¾ãšã¯ã€èªå¯ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ãŸã‚ã® URL ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
Twitter API ã¯ã€Proof Key for Code Exchange (PKCE) ( [RFC7636](https://datatracker.ietf.org/doc/html/rfc7636))ã«å¯¾å¿œã—ã¦ã„ã‚‹ã®ã§ã€ãã®å‡¦ç†ã‚‚è¡Œã„ã¾ã™ã€‚

{/* {<note text="ä»Šå›ã¯æ¤œè¨¼ç”¨ã®ãŸã‚ã€stateã‚„code_verifierã®ä¿å­˜ã¯é©å½“ã§ã™ã€‚æ­£ã—ã„å‡¦ç†ã¯RFCã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚">} */}

```go
package main

import "golang.org/x/oauth2"

// TODO: æœ¬ç•ªã§ã¯å›ºå®šå€¤ã§ã¯ãªãã€ãƒ–ãƒ©ã‚¦ã‚¶ã”ã¨ã«ç•°ãªã‚‹å€¤ã‚’ç”Ÿæˆã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„
// https://www.rfc-editor.org/rfc/rfc6749.html#section-10.12
// The binding value used for CSRF
// protection MUST contain a non-guessable value (as described in Section 10.10),
// and the user-agent's authenticated state (e.g., session cookie, HTML5 local storage) MUST be kept in a location
// accessible only to the client and the user-agent (i.e., protected by same-origin policy)
const state = "FIXME"

var config = oauth2.Config{
		ClientID:     os.Getenv("TWITTER_CLIENT_ID"),
		ClientSecret: os.Getenv("TWITTER_CLIENT_SECRET"),
		Endpoint: oauth2.Endpoint{
			AuthURL:   "https://twitter.com/i/oauth2/authorize",
			TokenURL:  "https://api.twitter.com/2/oauth2/token",
			AuthStyle: oauth2.AuthStyleInHeader,
		},
		RedirectURL: "http://localhost:8080/callback",
		Scopes:      []string{"tweet.read", "users.read", "tweet.write"},
	}

var codeVerifier string

func buildAuthorizationURL(config oauth2.Config) string {
	// PKCE å¯¾å¿œ https://datatracker.ietf.org/doc/html/rfc7636
	// TODO: æœ¬ç•ªã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã”ã¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¦ãã ã•ã„
	codeVerifier = generateBase64Encoded32byteRandomString()
	h := sha256.New()
	h.Write([]byte(codeVerifier))
	hashed := h.Sum(nil)
	codeChallenge := base64.URLEncoding.WithPadding(base64.NoPadding).EncodeToString(hashed)

	url := config.AuthCodeURL(
		state,
		oauth2.SetAuthURLParam("code_challenge", codeChallenge),
		oauth2.SetAuthURLParam("code_challenge_method", "S256"))
	return url
}
```

URL ã‚’ç”Ÿæˆã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã‚‰ã€GET ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç”Ÿã‚„ã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```go
func main() {
	r := mux.NewRouter()
	r.HandleFunc("/login", loginHandler).Methods("GET")
	srv := &http.Server{
		Handler: r,
		Addr:    "127.0.0.1:8080",
	}

	log.Println("Click the following link to login: http://localhost:8080/login")
	log.Fatal(srv.ListenAndServe())
}

func loginHandler(w http.ResponseWriter, r *http.Request) {
	url := buildAuthorizationURL(config)
	log.Println(url)
	w.Header().Set("Location", url)
	w.WriteHeader(http.StatusFound)
	return
}
```

ã“ã“ã¾ã§å®Ÿè£…ã—ãŸã‚‰ã€Web ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¦ã€http://localhost:8080/login ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚
ã™ã‚‹ã¨ã€ä»Šã¾ã§ã® Twitter ã®èªå¯ç”»é¢ã¨ã¯ç•°ãªã‚‹ã€æ–°ã—ã„èªå¯ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![æ–°ã—ã„èªå¯ç”»é¢](./authorize.png)
_æ–°ã—ã„èªå¯ç”»é¢_

èªå¯ç”»é¢ã‚’è¦‹ã‚‹ã¨ã€ä»Šå›è¨­å®šã—ãŸã‚¹ã‚³ãƒ¼ãƒ—ã®ã¿ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ï¼

### ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å®Ÿè£…

æ¬¡ã¯ã€ã€Œã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸå¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
ä»Šå›ã¯ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ãŸã‚‰ã€è‡ªåˆ†è‡ªèº«ã®æƒ…å ±ã‚’å–å¾—ã—ã€API ã® JSON ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãã®ã¾ã¾è¿”ã—ã¾ã™ã€‚

```go
func callbackHandler(w http.ResponseWriter, r *http.Request) {
	queryCode := r.URL.Query().Get("code")
	if queryCode == "" {
		log.Println("code not found")
		w.WriteHeader(http.StatusBadRequest)
		return
	}
	queryState := r.URL.Query().Get("state")
	if queryState == "" {
		log.Println("state not found")
		w.WriteHeader(http.StatusBadRequest)
		return
	}
	if queryState != state {
		log.Println("invalid state")
		w.WriteHeader(http.StatusBadRequest)
		return
	}

	token, err := config.Exchange(context.Background(), queryCode,
                          oauth2.SetAuthURLParam("code_verifier", codeVerifier))
	if err != nil {
		log.Printf("failed to exchange token: %v\n", err)
		w.WriteHeader(http.StatusBadRequest)
		return
	}
	log.Printf("token scope: %v\n", token.Extra("scope"))

	oAuthClient := oauth2.NewClient(r.Context(), oauth2.StaticTokenSource(token))

	// https://developer.twitter.com/en/docs/twitter-api/users/lookup/api-reference/get-users-me
	res, err := oAuthClient.Get("https://api.twitter.com/2/users/me")
	if err != nil {
		log.Printf("failed to get me: %v\n", err)
		w.WriteHeader(http.StatusInternalServerError)
		return
	}
	defer res.Body.Close()

	w.Header().Set("Content-Type", "application/json")
	_, _ = io.Copy(w, res.Body)
}

func main() {
	r := mux.NewRouter()
	r.HandleFunc("/login", loginHandler).Methods("GET")
	r.HandleFunc("/callback", callbackHandler).Methods("GET") // è¿½åŠ 

	srv := &http.Server{
		Handler: r,
		Addr:    "127.0.0.1:8080",
	}

	log.Println("Click the following link to login: http://localhost:8080/login")
	log.Fatal(srv.ListenAndServe())
}
```

ãƒ—ãƒ­ã‚»ã‚¹ã‚’å†èµ·å‹•ã—ã€èªå¯ã‚’ã—ã¦ã¿ã¾ã™ã€‚

ã™ã‚‹ã¨ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã¯æ¬¡ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã€æŒ‡å®šã—ãŸã‚¹ã‚³ãƒ¼ãƒ—ã‚’æŒã¤ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```text
token scope: tweet.write users.read tweet.read
```

ã¾ãŸã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã«ã¯ã€Twitter API ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ ğŸ‰

![v2 APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹](./user_info.png)
_v2 API ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹_

## ãŠã‚ã‚Šã«

ä»Šå›ã¯ Twitter API v2 ã§è¿½åŠ ã•ã‚ŒãŸ OAuth2.0 Authorization Code Flow ã‚’è©¦ã—ã¾ã—ãŸã€‚

ä»Šã¾ã§ä»¥ä¸Šã«ã‚¹ã‚³ãƒ¼ãƒ—ã®è‡ªç”±åº¦ãŒåºƒãŒã‚Šã€ä»Šå¾Œã©ã‚“ã©ã‚“åºƒãä½¿ã‚ã‚Œã¦ã„ãã‚ˆã†ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚
ã“ã‚Œã§ã€Œã€‡ã€‡ã‚¢ãƒ—ãƒªãŒä¸å¿…è¦ã«æ¨©é™ã‚’è¦æ±‚ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ï¼å±ãªã„ï¼ã€ã¿ãŸã„ãªãƒ„ã‚¤ãƒ¼ãƒˆãŒæ¸›ã‚‹ã¨è‰¯ã„ã§ã™ã­ã€‚
